<!-- templates/admin.html -->
{{define "content"}}
<div class="space-y-8 animate-fade-in-up">
  <!-- Upload Section -->
  <div class="theme-card p-8 text-center transition-transform hover:scale-[1.01] duration-300">
    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
      <div id="dropZone"
        class="group cursor-pointer rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 py-12 px-6 transition-all duration-300 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/10 dark:hover:border-primary-500">
        <div class="flex flex-col items-center space-y-4">
          <div
            class="p-4 bg-white dark:bg-slate-800 rounded-full shadow-sm group-hover:scale-110 group-hover:text-primary-600 transition-all duration-300">
            <i
              class="fas fa-cloud-upload-alt text-4xl text-slate-400 group-hover:text-primary-600 dark:text-slate-500"></i>
          </div>
          <div class="space-y-2">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Upload a Book</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400 max-w-sm mx-auto">
              Support for EPUB, PDF, FB2, MOBI, AZW, CBZ, CBR, DJVU, RTF, TXT
            </p>
          </div>
          <button type="button" class="btn-primary mt-4"
            onclick="document.getElementById('book').click(); event.stopPropagation();">
            Choose File
          </button>
          <div id="fileInfo"
            class="hidden mt-4 text-sm font-medium text-primary-600 bg-primary-50 dark:bg-primary-900/20 px-4 py-2 rounded-full animate-fade-in">
          </div>
        </div>
      </div>
      <input type="file" id="book" name="book"
        accept=".epub,.pdf,.fb2,.fb2.zip,.cbz,.cbr,.cb7,.mobi,.azw,.azw3,.azw4,.djvu,.txt,.rtf,.html,.htm" required
        class="hidden" onclick="event.stopPropagation();" />
    </form>
  </div>

  <!-- Book Collection -->
  <div>
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Library Collection <span
          class="text-sm font-normal text-slate-500 ml-2">({{len .Books}} books)</span></h2>
      <div class="flex space-x-2">
        <!-- Future filters could go here -->
      </div>
    </div>

    {{if .Books}}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
      {{range .Books}}
      <div
        class="group relative theme-card overflow-hidden hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col h-full">
        <!-- Cover Image -->
        <div class="aspect-[2/3] relative overflow-hidden bg-slate-100 dark:bg-slate-800">
          <img src="/cover/{{.Filename}}"
            class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
            alt="{{.Title}}" loading="lazy"
            onerror="this.onerror=null;this.src='https://placehold.co/200x300/e2e8f0/64748b?text=No+Cover';">

          <!-- Overlay Actions -->
          <div
            class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center space-x-3 backdrop-blur-sm">
            <button onclick="openRenameModal('{{.Filename}}')"
              class="p-3 bg-white text-primary-600 rounded-full hover:bg-primary-600 hover:text-white transition-all transform hover:scale-110 shadow-lg"
              title="Edit Filename">
              <i class="fas fa-edit"></i>
            </button>
            <a href="/books/{{.Filename}}"
              class="p-3 bg-white text-slate-900 rounded-full hover:bg-primary-500 hover:text-white transition-all transform hover:scale-110 shadow-lg"
              title="Download" download>
              <i class="fas fa-download"></i>
            </a>
            <form action="/delete/{{.Filename}}" method="post" onsubmit="return confirm('Delete {{.Title}}?');">
              <button type="submit"
                class="p-3 bg-white text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-all transform hover:scale-110 shadow-lg"
                title="Delete">
                <i class="fas fa-trash-alt"></i>
              </button>
            </form>
          </div>
        </div>

        <!-- Content -->
        <div class="p-4 flex flex-col flex-grow">
          <h3 class="font-semibold text-slate-900 dark:text-white text-sm line-clamp-2 mb-2 leading-tight"
            title="{{.Title}}">{{.Title}}</h3>
          <div class="mt-auto flex items-center justify-between text-xs font-medium text-slate-500 dark:text-slate-400">
            <span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
              {{.MimeType | simpleMime}}
            </span>
            <span>{{formatSize .Size}}</span>
          </div>
        </div>
      </div>
      {{end}}
    </div>
    {{else}}
    <div class="text-center py-20 theme-card rounded-2xl border-dashed border-2">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 mb-4">
        <i class="fas fa-book-open text-3xl text-slate-400"></i>
      </div>
      <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-1">No books yet</h3>
      <p class="text-slate-500">Upload some books to get started with your library.</p>
    </div>
    {{end}}
  </div>

  <!-- OPDS Info -->
  <div
    class="theme-card p-6 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4 bg-gradient-to-r from-slate-50 to-white dark:from-slate-800 dark:to-slate-900">
    <div class="flex items-center space-x-4">
      <div class="p-3 bg-primary-100 dark:bg-primary-900/30 rounded-lg text-primary-600 dark:text-primary-400">
        <i class="fas fa-rss text-xl"></i>
      </div>
      <div>
        <h3 class="font-medium text-slate-900 dark:text-white">OPDS Feed URL</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400">Add this to your reader app</p>
      </div>
    </div>
    <div
      class="flex items-center w-full sm:w-auto bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-2 shadow-sm">
      <code
        class="text-sm text-slate-600 dark:text-slate-300 font-mono flex-grow px-2 truncate selection:bg-primary-100">{{.BaseURL}}</code>
      <button onclick="navigator.clipboard.writeText('{{.BaseURL}}')"
        class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded text-slate-400 hover:text-primary-600 transition-colors"
        title="Copy URL">
        <i class="far fa-copy"></i>
      </button>
    </div>
  </div>
</div>
</div>

<!-- Rename Modal -->
<div id="renameModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden animate-fade-in">
  <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-100">
    <h3 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Rename Book</h3>
    <form action="/rename" method="post" id="renameForm">
      <input type="hidden" id="oldFilename" name="oldFilename" value="">
      <div class="space-y-4">
        <div>
          <label for="newFilename" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Book
            Name</label>
          <div class="flex rounded-md shadow-sm">
            <input type="text" id="newFilename" name="newFilename" required
              class="flex-1 min-w-0 block w-full px-4 py-2 rounded-l-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all">
            <span id="fileExtension"
              class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-sm">
              .ext
            </span>
          </div>
        </div>
        <div class="flex justify-end space-x-3 pt-2">
          <button type="button" onclick="closeRenameModal()"
            class="px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
            Cancel
          </button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors shadow-lg shadow-primary-500/30">
            Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("book");
    const fileInfo = document.getElementById("fileInfo");

    // Prevenir comportamientos por defecto
    ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    // Efecto visual al arrastrar
    dropZone.addEventListener("dragover", () => {
      dropZone.classList.add("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
    });

    // Manejar la soltar
    dropZone.addEventListener("drop", (e) => {
      dropZone.classList.remove("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
      const files = e.dataTransfer.files;
      if (files.length === 0) return;

      const file = files[0];
      const validTypes = [
        "application/pdf",
        "application/epub+zip",
        "application/x-fictionbook+xml",
        "application/zip",
        "application/x-cbz",
        "application/vnd.comicbook+zip",
        "application/x-cbr",
        "application/x-mobi",
        "application/x-mobipocket-ebook",
        "application/vnd.amazon.ebook",
        "image/vnd.djvu",
        "text/plain",
        "text/rtf",
        "application/rtf",
        "text/html"
      ];
      // Regex fallback for files with missing/generic mime
      const extRegex = /\.(epub|pdf|fb2|fb2\.zip|cbz|cbr|cb7|mobi|azw|azw3|azw4|djvu|txt|rtf|html|htm)$/i;

      if (!validTypes.includes(file.type) && !extRegex.test(file.name)) {
        fileInfo.classList.remove("hidden", "bg-primary-50", "text-primary-600");
        fileInfo.classList.add("text-red-600", "bg-red-50");
        fileInfo.textContent = "Invalid format. Supported: EPUB, PDF, FB2, MOBI, AZW, CBZ, CBR, DJVU, TXT, RTF";
        return;
      }

      // Asignar al input y mostrar info
      fileInput.files = files;
      const sizeMB = (file.size / 1024 / 1024).toFixed(2);
      fileInfo.classList.remove("hidden", "text-red-600", "bg-red-50");
      fileInfo.classList.add("text-primary-600", "bg-primary-50");
      fileInfo.textContent = `Selected: ${file.name} (${sizeMB} MB)`;

      // Auto-submit
      document.getElementById("uploadForm").submit();
    });

    // Handle click on dropzone to trigger input
    dropZone.addEventListener("click", () => fileInput.click());

    // También al cambiar por clic
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;
      const sizeMB = (file.size / 1024 / 1024).toFixed(2);
      fileInfo.classList.remove("hidden");
      fileInfo.textContent = `Archivo seleccionado: ${file.name} (${sizeMB} MB)`;
    });

  });

  // Rename Modal Logic
  function openRenameModal(filename) {
    const modal = document.getElementById('renameModal');
    const oldInput = document.getElementById('oldFilename');
    const newInput = document.getElementById('newFilename');
    const extSpan = document.getElementById('fileExtension');

    oldInput.value = filename;

    // Extract basename from full path (e.g. "subdir/book.epub" -> "book.epub")
    // Handles both forward and backward slashes just in case
    const basename = filename.split('/').pop().split('\\').pop();

    // Split name and extension
    const lastDotIndex = basename.lastIndexOf('.');
    if (lastDotIndex > 0) {
      newInput.value = basename.substring(0, lastDotIndex);
      extSpan.textContent = basename.substring(lastDotIndex);
    } else {
      newInput.value = filename;
      extSpan.textContent = "";
    }

    modal.classList.remove('hidden');
    newInput.focus();
    newInput.select();
  }

  function closeRenameModal() {
    const modal = document.getElementById('renameModal');
    modal.classList.add('hidden');
  }

  // Close modal on click outside
  document.getElementById('renameModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('renameModal')) {
      closeRenameModal();
    }
  });
</script>
{{end}}
