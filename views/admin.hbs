<div class="space-y-8 animate-fade-in-up">
  <!-- Upload Section -->
  <div class="theme-card p-8 text-center transition-transform hover:scale-[1.01] duration-300">

    <form action="/book/upload" method="post" enctype="multipart/form-data" id="uploadForm">
      <div id="dropZone"
        class="group cursor-pointer rounded-2xl border-2 border-dashed border-neutral-300 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/50 py-12 px-6 transition-all duration-300 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/10 dark:hover:border-primary-500">
        <div class="flex flex-col items-center space-y-4">
          <div
            class="p-4 bg-white dark:bg-neutral-800 rounded-full shadow-sm group-hover:scale-110 group-hover:text-primary-600 transition-all duration-300">
            <i
              class="fas fa-cloud-upload-alt text-4xl text-neutral-400 group-hover:text-primary-600 dark:text-neutral-500"></i>
          </div>
          <div class="space-y-2">
            <h3 class="text-lg font-semibold text-neutral-900 dark:text-white">Upload a Book</h3>
            <p class="text-sm text-neutral-500 dark:text-neutral-400 max-w-sm mx-auto">
              Support for EPUB, PDF, FB2, MOBI, AZW, CBZ, CBR, DJVU, RTF, TXT
            </p>
          </div>
          <button type="button" class="btn-primary mt-4"
            onclick="document.getElementById('book').click(); event.stopPropagation();">
            Choose File
          </button>
          <div id="fileInfo"
            class="hidden mt-4 text-sm font-medium text-primary-600 bg-primary-50 dark:bg-primary-900/20 px-4 py-2 rounded-full animate-fade-in">
          </div>
        </div>
      </div>
      <input type="file" id="book" name="book"
        accept=".epub,.pdf,.fb2,.fb2.zip,.cbz,.cbr,.cb7,.mobi,.azw,.azw3,.azw4,.djvu,.txt,.rtf,.html,.htm" required
        class="hidden" onclick="event.stopPropagation();" />
    </form>
  </div>

  <!-- Book Collection -->
  <div>
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
      <h2 class="text-2xl font-bold text-neutral-900 dark:text-white">Library Collection <span id="booksCount"
          class="text-sm font-normal text-neutral-500 ml-2">({{len books}} books)</span></h2>
      <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
        <div class="relative flex-grow sm:w-64">
          <input type="text" id="bookSearch" placeholder="Search books..."
            class="w-full pl-10 pr-4 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
        </div>
        <div class="relative">
          <select id="bookSort"
            class="w-full sm:w-48 pl-10 pr-8 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all appearance-none cursor-pointer">
            <option value="name-asc" {{#if (eq sortMode "name-asc" )}}selected{{/if}}>Name (A-Z)</option>
            <option value="name-desc" {{#if (eq sortMode "name-desc" )}}selected{{/if}}>Name (Z-A)</option>
            <option value="date-desc" {{#if (or (eq sortMode "" ) (eq sortMode "date-desc" ))}}selected{{/if}}>Newest
              First</option>
            <option value="date-asc" {{#if (eq sortMode "date-asc" )}}selected{{/if}}>Oldest First</option>
          </select>
          <i class="fas fa-sort-amount-down absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
          <i
            class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none text-xs"></i>
        </div>
      </div>
    </div>

    {{#if books}}
    <div id="booksGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
      {{#each books}}
      <div data-title="{{this.title}}" data-added="{{this.lastUpdated}}"
        class="book-card group relative theme-card overflow-hidden hover:shadow-lg hover:-translate-y-1 transition-all duration-300 flex flex-col h-full focus:outline-none"
        tabindex="0"
        onmouseover="document.getElementById('{{this.filename}}').classList.remove('hidden'); document.getElementById('{{this.filename}}').classList.add('flex')"
        onmouseout="document.getElementById('{{this.filename}}').classList.add('hidden'); document.getElementById('{{this.filename}}').classList.remove('flex')">

        <!-- Cover Image -->
        <div class="aspect-[2/3] relative overflow-hidden bg-neutral-100 dark:bg-neutral-800">
          <img src="/book/cover/{{this.filename}}" class="w-full h-full object-cover" alt="{{this.title}}"
            loading="lazy" onerror="this.onerror=null;this.src='/static/no-cover-error.svg';">
        </div>

        <!-- Overlay Actions -->
        <div class="flex flex-1 absolute w-full dark:bg-dark-card hidden" id="{{this.filename}}">
          <button onclick="openRenameModal('{{this.filename}}')"
            class="py-2 flex-1 text-center text-primary-600 hover:bg-primary-600 hover:text-white  cursor-pointer"
            title="Edit Filename">
            <i class="fas fa-edit"></i>
          </button>
          <a href="/book/{{this.filename}}"
            class="py-2 flex-1 text-center text-primary-600 hover:bg-primary-500 hover:text-white  cursor-pointer"
            title="Download" download>
            <i class="fas fa-download"></i>
          </a>
          <form action="/book/delete/{{this.filename}}" method="post"
            onsubmit="return confirm('Delete {{this.title}}?');"
            class="flex-1 text-center text-red-500 hover:bg-red-500 hover:text-white cursor-pointer">
            <button type="submit" class="cursor-pointer py-2 h-full w-full" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          </form>
        </div>

        <!-- Content -->
        <div class="px-4 py-2 flex flex-col flex-grow">
          <h3 class="font-semibold text-neutral-900 dark:text-white text-sm line-clamp-2 mb-2 leading-tight"
            title="{{this.title}}">{{this.title}}</h3>
          <div
            class="mt-auto flex items-center justify-between text-xs font-medium text-neutral-500 dark:text-neutral-400">
            <span class="px-2 py-1 rounded bg-neutral-100 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300">
              {{simpleMime this.mimeType}}
            </span>
            <span>{{formatSize this.size}}</span>
          </div>
        </div>
      </div>
      {{/each}}
    </div>
    {{else}}
    <div class="text-center py-20 theme-card rounded-2xl border-dashed border-2">
      <div
        class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-neutral-100 dark:bg-neutral-800 mb-4">
        <i class="fas fa-book-open text-3xl text-neutral-400"></i>
      </div>
      <h3 class="text-lg font-medium text-neutral-900 dark:text-white mb-1">No books yet</h3>
      <p class="text-neutral-500">Upload some books to get started with your library.</p>
    </div>
    {{/if}}
  </div>

  <!-- OPDS Info -->
  <div
    class="theme-card p-6 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-4 bg-gradient-to-r from-neutral-50 to-white dark:from-neutral-800 dark:to-neutral-900">
    <div class="flex items-center space-x-4">
      <div class="p-3 bg-primary-100 dark:bg-primary-900/30 rounded-lg text-primary-600 dark:text-primary-400">
        <i class="fas fa-rss text-xl"></i>
      </div>
      <div>
        <h3 class="font-medium text-neutral-900 dark:text-white">OPDS Feed URL</h3>
        <p class="text-sm text-neutral-500 dark:text-neutral-400">Add this to your reader app. Support sorting with
          <code>?sort=name-asc|date-desc</code>
        </p>
      </div>
    </div>
    <div
      class="flex items-center w-full sm:w-auto bg-white dark:bg-neutral-950 border border-neutral-200 dark:border-neutral-800 rounded-lg p-2 shadow-sm">
      <code id="opdsUrlDisplay"
        class="text-sm text-neutral-600 dark:text-neutral-300 font-mono flex-grow px-2 truncate selection:bg-primary-100">{{baseUrl}}</code>
      <button id="opdsCopyBtn" data-base-url="{{baseUrl}}"
        class="p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800 rounded text-neutral-400 hover:text-primary-600 transition-colors"
        title="Copy URL">
        <i class="far fa-copy"></i>
      </button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div id="renameModal"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden animate-fade-in">
  <div
    class="bg-white dark:bg-neutral-800 rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-100">
    <h3 class="text-xl font-bold mb-4 text-neutral-900 dark:text-white">Rename Book</h3>
    <form action="/book/rename" method="post" id="renameForm">
      <input type="hidden" id="oldFilename" name="oldFilename" value="">
      <div class="space-y-4">
        <div>
          <label for="newFilename" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">Book
            Name</label>
          <div class="flex rounded-md shadow-sm">
            <input type="text" id="newFilename" name="newFilename" required
              class="flex-1 min-w-0 block w-full px-4 py-2 rounded-l-lg border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all">
            <span id="fileExtension"
              class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-neutral-300 dark:border-neutral-600 bg-neutral-50 dark:bg-neutral-800 text-neutral-500 dark:text-neutral-400 text-sm">
              .ext
            </span>
          </div>
        </div>
        <div class="flex justify-end space-x-3 pt-2">
          <button type="button" onclick="closeRenameModal()"
            class="px-4 py-2 rounded-lg text-neutral-700 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors">
            Cancel
          </button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors shadow-lg shadow-primary-500/30">
            Save Changes
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<script data-total-books="{{len books}}">
  document.addEventListener("DOMContentLoaded", () => {
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("book");
    const fileInfo = document.getElementById("fileInfo");

    ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    dropZone.addEventListener("dragover", () => {
      dropZone.classList.add("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
    });
    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
    });

    dropZone.addEventListener("drop", (e) => {
      dropZone.classList.remove("border-primary-500", "bg-primary-50", "dark:bg-primary-900/10");
      const files = e.dataTransfer.files;
      if (files.length === 0) return;

      const file = files[0];
      const validTypes = [
        "application/pdf",
        "application/epub+zip",
        "application/x-fictionbook+xml",
        "application/zip",
        "application/x-cbz",
        "application/vnd.comicbook+zip",
        "application/x-cbr",
        "application/x-mobi",
        "application/x-mobipocket-ebook",
        "application/vnd.amazon.ebook",
        "image/vnd.djvu",
        "text/plain",
        "text/rtf",
        "application/rtf",
        "text/html"
      ];
      // Regex fallback for files with missing/generic mime
      const extRegex = /\.(epub|pdf|fb2|fb2\.zip|cbz|cbr|cb7|mobi|azw|azw3|azw4|djvu|txt|rtf|html|htm)$/i;

      if (!validTypes.includes(file.type) && !extRegex.test(file.name)) {
        fileInfo.classList.remove("hidden", "bg-primary-50", "text-primary-600");
        fileInfo.classList.add("text-red-600", "bg-red-50");
        fileInfo.textContent = "Invalid format. Supported: EPUB, PDF, FB2, MOBI, AZW, CBZ, CBR, DJVU, TXT, RTF";
        return;
      }

      fileInput.files = files;
      document.getElementById("uploadForm").submit();
    });

    dropZone.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
      document.getElementById("uploadForm").submit();
    });

  });

  // Rename Modal Logic
  function openRenameModal(filename) {
    const modal = document.getElementById('renameModal');
    const oldInput = document.getElementById('oldFilename');
    const newInput = document.getElementById('newFilename');
    const extSpan = document.getElementById('fileExtension');

    oldInput.value = filename;

    const basename = filename.split('/').pop().split('\\').pop();
    const lastDotIndex = basename.lastIndexOf('.');
    if (lastDotIndex > 0) {
      newInput.value = basename.substring(0, lastDotIndex);
      extSpan.textContent = basename.substring(lastDotIndex);
    } else {
      newInput.value = filename;
      extSpan.textContent = "";
    }

    modal.classList.remove('hidden');
    newInput.focus();
    newInput.select();
  }

  function closeRenameModal() {
    const modal = document.getElementById('renameModal');
    modal.classList.add('hidden');
  }

  // Close modal on click outside
  document.getElementById('renameModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('renameModal')) {
      closeRenameModal();
    }
  });

  // Search and Sort functionality
  const searchInput = document.getElementById('bookSearch');
  const sortSelect = document.getElementById('bookSort');
  const booksGrid = document.getElementById('booksGrid');
  const booksCount = document.getElementById('booksCount');
  const totalBooks = parseInt(document.currentScript.dataset.totalBooks, 10) || 0;

  function filterAndSortBooks() {
    if (!booksGrid) return;

    const query = searchInput.value.toLowerCase().trim();
    const sortMode = sortSelect.value;
    const bookCards = Array.from(booksGrid.querySelectorAll('.book-card'));
    let visibleCount = 0;

    // Filter
    bookCards.forEach(card => {
      const title = (card.dataset.title || '').toLowerCase();
      if (title.includes(query)) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Sort
    bookCards.sort((a, b) => {
      if (sortMode === 'name-asc') {
        return a.dataset.title.localeCompare(b.dataset.title);
      } else if (sortMode === 'name-desc') {
        return b.dataset.title.localeCompare(a.dataset.title);
      } else if (sortMode === 'date-desc') {
        return (new Date(b.dataset.added).getTime()) - (new Date(a.dataset.added).getTime());
      } else if (sortMode === 'date-asc') {
        return (new Date(a.dataset.added).getTime()) - (new Date(b.dataset.added).getTime());
      }
      return 0;
    });

    // Reorder DOM
    bookCards.forEach(card => booksGrid.appendChild(card));

    // Update count
    if (booksCount) {
      if (query) {
        booksCount.textContent = `(${visibleCount} of ${totalBooks} books)`;
      } else {
        booksCount.textContent = `(${totalBooks} books)`;
      }
    }
  }

  const opdsUrlDisplay = document.getElementById('opdsUrlDisplay');
  const opdsCopyBtn = document.getElementById('opdsCopyBtn');

  function updateOpdsUrl() {
    if (!opdsUrlDisplay || !opdsCopyBtn || !sortSelect) return;
    const baseUrl = opdsCopyBtn.dataset.baseUrl;
    const sortMode = sortSelect.value;
    const fullUrl = `${baseUrl}/?sort=${sortMode}`;
    opdsUrlDisplay.textContent = fullUrl;
  }

  if (opdsCopyBtn) {
    opdsCopyBtn.addEventListener('click', () => {
      navigator.clipboard.writeText(opdsUrlDisplay.textContent);
      const icon = opdsCopyBtn.querySelector('i');
      icon.classList.replace('far', 'fas');
      icon.classList.replace('fa-copy', 'fa-check');
      setTimeout(() => {
        icon.classList.replace('fas', 'far');
        icon.classList.replace('fa-check', 'fa-copy');
      }, 2000);
    });
  }

  if (searchInput && sortSelect && booksGrid) {
    searchInput.addEventListener('input', filterAndSortBooks);
    sortSelect.addEventListener('change', () => {
      filterAndSortBooks();
      updateOpdsUrl();
      // Update URL without reloading to persist sort choice on refresh
      const url = new URL(window.location);
      url.searchParams.set('sort', sortSelect.value);
      window.history.pushState({}, '', url);
    });

    // Initial sort and URL setup
    filterAndSortBooks();
    updateOpdsUrl();
  }
</script>
